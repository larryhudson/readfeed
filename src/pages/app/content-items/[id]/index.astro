---
import { Debug } from "astro:components";
import Layout from "@src/components/Layout.astro";

import {
  getContentItemById,
  getContentPartsForContentItem,
} from "@src/content-items";

const contentItemIdStr = Astro.params.id;
const contentItemId = parseInt(contentItemIdStr, 10);

const session = await Astro.locals.auth.validate();
const userId = session.user.userId;

const contentItem = await getContentItemById(contentItemId);
console.log(contentItem);
if (contentItem.feeds.userId !== userId) {
  return new Response("Unauthorized", { status: 401 });
}

const contentParts = await getContentPartsForContentItem(contentItemId);
---

<Layout>
  <h1>Content item: {contentItem.title}</h1>
  <p>URL: <a href={contentItem.url}>{contentItem.url}</a></p>

  <h2>Text content</h2>

  <button
    hx-post={`/app/content-items/${contentItemId}/x-fetch-text-content`}
    hx-target="#text-content"
    hx-swap="innerHTML"
    >{contentItem.textContent ? "Refetch content" : "Fetch content"}</button
  >

  <div id="text-content">
    {contentItem.textContent && contentItem.textContent}
  </div>
  <Debug {contentItem} />

  <h2>Looking up content parts separately</h2>
  <Debug {contentParts} />
</Layout>

<style>
  #text-content {
    white-space: pre-wrap;
  }
</style>
